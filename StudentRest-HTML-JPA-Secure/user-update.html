<!DOCTYPE HTML> 
<html>
<head>
<link rel="stylesheet" type="text/css" href="style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

</head>
<body> 
<script>
function getCurrentUser() {
	$.ajax({
	    url: "/EagleEventService/system/systemservices/users/current",
	    type: 'GET',
	    datatype: 'json',
	    statusCode: {
	    200: function( response ) {
	
			$('#userWelcome').html("Welcome, "+response.firstName+" "+response.lastName);
	    },
	    401:function( response ) {
	    		$('#page-messge').html("You must Login first");}
	    },
	    
	    error: function(jqXHR, textStatus, errorThrown) {
  	        console.log("error " + textStatus);
  	        console.log("incoming Text " + jqXHR.responseText);},
	    beforeSend: setHeader       
	  });   	
}
function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

function setHeader(xhr) {
	  token = getCookie("token");
	  xhr.setRequestHeader('Authorization', 'Bearer '+token );		  
}

$.urlParam = function(name){
    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results==null){
       return null;
    }
    else{
       return results[1] || 0;
    }
}



$(document).ready(function() {
	
	getCurrentUser();
	
	$.ajax({
	    url: "/EagleEventService/system/systemservices/users/"+$.urlParam("id"),
	    type: 'GET',
	    datatype: 'json',
	    statusCode: {
	    200: function(response) {
	    		$('#id').val(response.userId);
			$('#firstName').val(response.firstName);
			$('#lastName').val(response.lastName);
			$('#userName').val(response.userName);
			$('#password').val(response.password);
			$('#email').val(response.email);
			
			$.each(response.roleAssignments, function(i,e){
			    $("#role option[value='" + e.role + "']").prop("selected", true);
			});
			},
			
	    401:function( response ) {
	    		$('#page-messge').html("You must Login first");
	    		},
		403:function( response ) {
  	    		$('#page-messge').html("Access to the page forbiden");
  	    		}

	    		},
	    
	    error: function(jqXHR, textStatus, errorThrown) {
  	        console.log("error " + textStatus);
  	        console.log("incoming Text " + jqXHR.responseText);
  	        },
	    beforeSend: setHeader   
	  }); 
	
		$("#userForm").submit(function (e){
				e.preventDefault;
				var firstName = $('#firstName').val();
				var lastName = $('#lastName').val();
				var userName= $('#userName').val();
				var password = $('#password').val();
				var email = $('#email').val();
				var selectedValues = $('#role').val();
				
				var jsonData = 
					'{'+  
					'"userID" :"'+ $.urlParam("id")+'",'+
					'"firstName" :"'+ firstName+'",'+
					'"lastName" : "'+lastName+'",'+
					'"userName" : "'+userName+'",'+
					'"password" : "'+password+'",'+
					'"email" : "'+email+'",'+
					'"roleAssignments" : [';
				cm=",";
				$.each(selectedValues, function(i,e){
						if (i==selectedValues.length-1) cm='';
					    jsonData += ' { "role":"'+ e+'"}'+cm;
					});
				jsonData +="]}",
				$.ajax( { 
					url:"/EagleEventService/system/systemservices/users/"+$.urlParam("id"),
					type: "PUT",
					dataType: "json",
					contentType: "application/json",
					data: jsonData,
					statusCode: {
						200: function(response) {
							  $("#page-message").html("Record Updated");
							  window.location.assign("user-list.html");
					  		},
					  	401:function( response ) {
				    			$('#page-messge').html("You must Login first");
				    			},
					  	403:function( response ) {
				  	    		$('#page-messge').html("Access to the page forbiden");
				  	    		},
					  	406: function(response) {
					  		var errors = response.responseJSON;
					  		$(".error").html("*");
					  		$.each(errors, function (i, message) {
					  			$("#"+message.attributeName+"Err").html(message.message);
					  			console.log("Error "+message.attributeName +" "+message.message)
			    	        		});
					  		$("#page-message").html("Fix errors and click Save");
					  	},
					  					  	
						404: function(jqXHR, textStatus, errorThrown) {
							$("#page-message").html("Error:"+textStatus);
							consule.log(errorThrown);
				  	        console.log("error " + textStatus);
				  	        console.log("incoming Text " + jqXHR.responseText);
				  	      }
						},
						beforeSend: setHeader
					});
		
				e.preventDefault();
		});
	});
</script>
<div>
<ul class="nav">
<li><a href="student-list.html">Students</a></li>
<li><a href="user-list.html">Users</a></li>
<li><a href="logout.html">Logout</a></li>
</ul>
</div>
<div id="userWelcome"> </div>
<h2>User Update</h2>
<p id ='debug'></p>
<div class ='block-center'>
<p><span class="error-head">* required field.</span></p>
<p><span id="page-messge">Enter fields and click Save</span></p>
<form id="userForm" > 

   Fist Name: <input type="text" id="firstName">
   <span id="firstNameErr" class="error">* </span>
   <br><br>
   Last Name: <input type="text" id="lastName" ">
   <span id="lastNameErr" class="error">* </span>
   <br><br>
   Username: <input type="text" id="userName">
   <span id ="userNameErr" class="error">* </span>
   <br><br>
   Password: <input type="text" id="password">
   <span id="passwordErr" class="error">* </span>
   <br><br>
   E-mail: <input type="text" id="email" >
   <span id="emailErr" class="error">* </span>
   <br><br>
   Role : <select class="select-style" id="role" multiple="multiple"><option value="ADMIN">Admin</option>
 	<option value="USER">User</option>
   </select>
	<br><br>
   <input type="submit" name="submit" value="Save"> 
</form>
<form action="user-list.html" method ="get">
<button type="submit" >Cancel</button>
</form>

</div>
</body>
</html>
